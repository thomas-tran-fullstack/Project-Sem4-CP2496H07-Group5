<?xml version="1.0" encoding="UTF-8"?>
<ui:composition template="/templates/admin/layout.xhtml" xmlns="http://www.w3.org/1999/xhtml"
    xmlns:h="jakarta.faces.html" xmlns:ui="jakarta.faces.facelets" xmlns:f="jakarta.faces.core"
    xmlns:c="http://xmlns.jcp.org/jsp/jstl/core">
    <ui:define name="content">
        <!-- Scrollable Page Content -->
        <div class="flex-1 overflow-y-auto p-4 md:p-8 scroll-smooth">
            <div class="max-w-[1200px] mx-auto space-y-6">
                <!-- Page Header -->
                <div class="flex flex-col md:flex-row md:items-center justify-between gap-4">
                    <div>
                        <h2 class="text-2xl font-bold text-text-main dark:text-white tracking-tight">User Management
                        </h2>
                        <p class="text-text-sub text-sm mt-1">View, edit, and manage user accounts and permissions.</p>
                    </div>
                    <button
                        class="flex items-center justify-center gap-2 bg-primary hover:bg-primary-hover text-white px-5 py-2.5 rounded-lg shadow-sm shadow-primary/30 transition-all active:scale-95 font-medium">
                        <span class="material-symbols-outlined text-[20px]">add</span>
                        <span>Add New User</span>
                    </button>
                </div>
                <!-- Filters & Search Toolbar -->
                <div
                    class="bg-surface-light dark:bg-surface-dark p-4 rounded-xl border border-border-color shadow-sm flex flex-col lg:flex-row gap-4 items-center justify-between">
                    <!-- Search -->
                    <div class="relative w-full lg:max-w-md">
                        <span
                            class="material-symbols-outlined absolute left-3 top-1/2 -translate-y-1/2 text-text-sub pointer-events-none select-none text-[20px]">search</span>
                        <input
                            class="w-full pl-10 pr-4 py-2.5 bg-background-light dark:bg-background-dark border border-border-color rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-primary/50 focus:border-primary transition-all dark:text-white placeholder:text-text-sub/60"
                            placeholder="Search by name, email, or phone..." type="text" />
                    </div>
                    <!-- Filters -->
                    <div class="flex flex-wrap items-center gap-3 w-full lg:w-auto">
                        <div class="relative group">
                            <h:selectOneMenu value="#{userManagementController.selectedRole}"
                                onchange="submit()"
                                class="appearance-none pl-3 pr-10 py-2.5 bg-background-light dark:bg-background-dark border border-border-color rounded-lg text-sm text-text-sub focus:outline-none focus:ring-2 focus:ring-primary/50 cursor-pointer min-w-[120px]">
                                <f:selectItem itemLabel="Role: All" itemValue="All" />
                                <f:selectItem itemLabel="Admin" itemValue="ADMIN" />
                                <f:selectItem itemLabel="Customer" itemValue="CUSTOMER" />
                                <f:selectItem itemLabel="Staff" itemValue="STAFF" />
                            </h:selectOneMenu>
                            <span
                                class="material-symbols-outlined absolute right-2 top-1/2 -translate-y-1/2 text-text-sub pointer-events-none text-[18px]">expand_more</span>
                        </div>
                        <div class="relative group">
                            <h:selectOneMenu value="#{userManagementController.selectedStatus}"
                                onchange="submit()"
                                class="appearance-none pl-3 pr-10 py-2.5 bg-background-light dark:bg-background-dark border border-border-color rounded-lg text-sm text-text-sub focus:outline-none focus:ring-2 focus:ring-primary/50 cursor-pointer min-w-[120px]">
                                <f:selectItem itemLabel="Status: All" itemValue="All" />
                                <f:selectItem itemLabel="Active" itemValue="ACTIVE" />
                                <f:selectItem itemLabel="Inactive" itemValue="INACTIVE" />
                                <f:selectItem itemLabel="Banned" itemValue="BANNED" />
                            </h:selectOneMenu>
                            <span
                                class="material-symbols-outlined absolute right-2 top-1/2 -translate-y-1/2 text-text-sub pointer-events-none text-[18px]">expand_more</span>
                        </div>
                        <div class="relative group">
                            <h:selectOneMenu value="#{userManagementController.sortBy}"
                                onchange="submit()"
                                class="appearance-none pl-3 pr-10 py-2.5 bg-background-light dark:bg-background-dark border border-border-color rounded-lg text-sm text-text-sub focus:outline-none focus:ring-2 focus:ring-primary/50 cursor-pointer min-w-[140px]">
                                <f:selectItem itemLabel="Name: A - Z" itemValue="Name: A - Z" />
                                <f:selectItem itemLabel="Name: Z - A" itemValue="Name: Z - A" />
                                <f:selectItem itemLabel="Oldest Online" itemValue="Oldest Online" />
                                <f:selectItem itemLabel="Newest Online" itemValue="Newest Online" />
                            </h:selectOneMenu>
                            <span
                                class="material-symbols-outlined absolute right-2 top-1/2 -translate-y-1/2 text-text-sub pointer-events-none text-[18px]">expand_more</span>
                        </div>
                    </div>
                </div>
                <!-- Data Table Card -->
                <div
                    class="bg-surface-light dark:bg-surface-dark rounded-xl border border-border-color shadow-sm overflow-hidden">
                    <div class="overflow-x-auto">
                        <table class="w-full text-left border-collapse">
                            <thead>
                                <tr class="bg-background-light dark:bg-background-dark border-b border-border-color">
                                    <th class="py-4 px-6 text-xs font-semibold uppercase tracking-wider text-text-sub">
                                        User</th>
                                    <th class="py-4 px-6 text-xs font-semibold uppercase tracking-wider text-text-sub">
                                        Role</th>
                                    <th class="py-4 px-6 text-xs font-semibold uppercase tracking-wider text-text-sub">
                                        Status</th>
                                    <th class="py-4 px-6 text-xs font-semibold uppercase tracking-wider text-text-sub">
                                        Joined Date</th>
                                    <th class="py-4 px-6 text-xs font-semibold uppercase tracking-wider text-text-sub">
                                        Online</th>
                                    <th
                                        class="py-4 px-6 text-xs font-semibold uppercase tracking-wider text-text-sub text-right">
                                        Actions</th>
                                </tr>
                            </thead>
                            <tbody class="divide-y divide-border-color">
                                <ui:repeat var="user" value="#{userManagementController.users}">
                                    <tr class="group hover:bg-primary/5 transition-colors">
                                        <!-- User Info -->
                                        <td class="py-4 px-6">
                                            <div class="flex items-center gap-3">
                                                <div class="size-10 rounded-full bg-cover bg-center shrink-0"
                                                    style="background-image: url(&quot;#{userManagementController.getAvatarUrl(user)}&quot;);">
                                                </div>
                                                <div>
                                                    <p class="font-medium text-text-main dark:text-white">#{user.displayName}</p>
                                                    <p class="text-sm text-text-sub">#{user.email}</p>
                                                </div>
                                            </div>
                                        </td>
                                        <!-- Role -->
                                        <td class="py-4 px-6">
                                            <div class="flex items-center gap-2 text-sm text-text-main dark:text-gray-300">
                                                <h:panelGroup rendered="#{user.role eq 'ADMIN'}">
                                                    <span class="material-symbols-outlined text-[18px]" style="color: #a855f7;">verified_user</span>
                                                    Admin
                                                </h:panelGroup>
                                                <h:panelGroup rendered="#{user.role eq 'STAFF'}">
                                                    <span class="material-symbols-outlined text-[18px]" style="color: #0ea5e9;">person_check</span>
                                                    Staff
                                                </h:panelGroup>
                                                <h:panelGroup rendered="#{user.role eq 'CUSTOMER'}">
                                                    <span class="material-symbols-outlined text-[18px]" style="color: #3b82f6;">shopping_bag</span>
                                                    Customer
                                                </h:panelGroup>
                                            </div>
                                        </td>
                                        <!-- Status -->
                                        <td class="py-4 px-6">
                                            <h:panelGroup rendered="#{user.status eq 'ACTIVE'}">
                                                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800 dark:bg-green-900/30 dark:text-green-400">Active</span>
                                            </h:panelGroup>
                                            <h:panelGroup rendered="#{user.status eq 'INACTIVE'}">
                                                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-gray-100 text-gray-800 dark:bg-gray-900/30 dark:text-gray-400">Inactive</span>
                                            </h:panelGroup>
                                            <h:panelGroup rendered="#{user.status eq 'BANNED'}">
                                                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-red-100 text-red-800 dark:bg-red-900/30 dark:text-red-400">Banned</span>
                                            </h:panelGroup>
                                        </td>
                                        <!-- Joined Date -->
                                        <td class="py-4 px-6 text-sm text-text-sub">
                                            <h:outputText value="#{user.createdAt}" pattern="MMM dd, yyyy" />
                                        </td>
                                        <!-- Online Status -->
                                        <td class="py-4 px-6 text-sm">
                                            <h:panelGroup rendered="#{userManagementController.isUserOnline(user)}">
                                                <span class="inline-flex items-center gap-1.5 px-2.5 py-0.5 rounded-full bg-green-100 dark:bg-green-900/30">
                                                    <span class="size-2 bg-green-500 rounded-full animate-pulse"></span>
                                                    <span class="text-green-600 dark:text-green-400 font-medium text-xs">Online</span>
                                                </span>
                                            </h:panelGroup>
                                            <h:panelGroup rendered="#{!userManagementController.isUserOnline(user)}">
                                                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs bg-gray-100 dark:bg-gray-900/30 text-gray-600 dark:text-gray-400">
                                                    #{userManagementController.getFormattedOnlineTime(user)}
                                                </span>
                                            </h:panelGroup>
                                        </td>
                                        <!-- Actions -->
                                        <td class="py-4 px-6 text-right">
                                            <div class="flex items-center justify-end gap-2">
                                                <button
                                                    class="p-2 rounded-lg text-text-sub hover:text-primary hover:bg-primary/10 transition-colors"
                                                    title="Edit"
                                                    onclick="alert('Feature coming soon');">
                                                    <span class="material-symbols-outlined text-[20px]">edit</span>
                                                </button>
                                                <h:commandButton action="#{userManagementController.deleteUser(user.userID)}"
                                                    class="p-2 rounded-lg text-text-sub hover:text-red-500 hover:bg-red-50 transition-colors"
                                                    title="Delete"
                                                    onclick="return confirm('Bạn chắc chắn muốn xóa user này?');">
                                                    <span class="material-symbols-outlined text-[20px]">delete</span>
                                                </h:commandButton>
                                            </div>
                                        </td>
                                    </tr>
                                </ui:repeat>
                            </tbody>
                        </table>
                    </div>
                    <!-- Pagination Footer -->
                    <div
                        class="flex flex-col sm:flex-row items-center justify-between p-4 border-t border-border-color gap-4">
                        <p class="text-sm text-text-sub">Showing <span
                                class="font-medium text-text-main dark:text-white">#{userManagementController.users.size()}</span> users</p>
                        <div class="flex items-center gap-2">
                            <button
                                class="p-2 rounded-lg border border-border-color text-text-sub hover:bg-background-light hover:text-primary disabled:opacity-50 transition-colors"
                                disabled="">
                                <span class="material-symbols-outlined text-[20px]">chevron_left</span>
                            </button>
                            <button
                                class="px-3.5 py-2 rounded-lg bg-primary text-white text-sm font-medium hover:bg-primary-hover transition-colors shadow-sm shadow-primary/30">1</button>
                            <button
                                class="p-2 rounded-lg border border-border-color text-text-sub hover:bg-background-light hover:text-primary transition-colors">
                                <span class="material-symbols-outlined text-[20px]">chevron_right</span>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </ui:define>
    
    <!-- Auto-refresh script for real-time updates -->
    <ui:define name="scripts">
        <script type="text/javascript">
            // Store previous user data for change detection
            let previousUserData = {};
            
            // Real-time update every 1 second without full page reload
            setInterval(function() {
                // Use JSF AJAX to call refresh() on controller
                var form = document.querySelector('form');
                if (form) {
                    // Call the refresh() action without full page reload
                    jsf.ajax.request(form, event, {
                        execute: 'j_id1',
                        render: 'j_id1:userTable',
                        onevent: function(data) {
                            if(data.status === 'success') {
                                console.log('User list updated');
                                // Update online status colors immediately
                                updateOnlineStatusUI();
                            }
                        }
                    });
                }
            }, 1000); // Every 1 second
            
            // Update online status UI elements (green/gray badges)
            function updateOnlineStatusUI() {
                const statusElements = document.querySelectorAll('[data-last-online]');
                statusElements.forEach(el => {
                    const lastOnlineTime = el.getAttribute('data-last-online');
                    const isOnlineAttr = el.getAttribute('data-is-online');
                    
                    // Update badge class based on online status
                    if (isOnlineAttr === 'true') {
                        el.className = 'inline-flex items-center gap-2 px-3 py-1.5 rounded-lg bg-green-100 text-green-700 dark:bg-green-900 dark:text-green-200';
                    } else {
                        el.className = 'inline-flex items-center gap-2 px-3 py-1.5 rounded-lg bg-gray-100 text-gray-600 dark:bg-gray-700 dark:text-gray-300';
                    }
                });
            }
        </script>
    </ui:define>
</ui:composition>