<?xml version='1.0' encoding='UTF-8' ?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml"
      xmlns:h="http://xmlns.jcp.org/jsf/html"
      xmlns:f="http://xmlns.jcp.org/jsf/core"
      xmlns:p="http://primefaces.org/ui"
      xmlns:ui="http://xmlns.jcp.org/jsf/facelets">

    <h:head>
        <title>Voucher Management - EZMart Admin</title>
        <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    </h:head>

    <h:body>
        <ui:composition template="/templates/admin/layout.xhtml">
            <ui:define name="content">
                <h:form id="voucherForm">
                    <p:growl id="growl" showDetail="true" sticky="true" />

                    <!-- Header -->
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <h2><i class="fas fa-ticket-alt me-2"></i>Voucher Management</h2>
                        <p:commandButton value="Add New Voucher"
                                       icon="fas fa-plus"
                                       actionListener="#{voucherManagementMB.prepareCreate()}"
                                       oncomplete="PF('voucherDialog').show()"
                                       styleClass="btn btn-primary" />
                    </div>

                    <!-- Search and Filter -->
                    <div class="card mb-4">
                        <div class="card-body">
                            <div class="row g-3">
                                <div class="col-md-3">
                                    <label class="form-label">Search by Code</label>
                                    <p:inputText value="#{voucherManagementMB.searchCode}"
                                               placeholder="Enter voucher code"
                                               styleClass="form-control" />
                                </div>
                                <div class="col-md-2">
                                    <label class="form-label">Type</label>
                                    <p:selectOneMenu value="#{voucherManagementMB.selectedType}"
                                                   styleClass="form-select">
                                        <f:selectItem itemLabel="All Types" itemValue="#{null}" />
                                        <f:selectItem itemLabel="Offer" itemValue="offer" />
                                        <f:selectItem itemLabel="Customer" itemValue="customer" />
                                        <f:selectItem itemLabel="General" itemValue="general" />
                                    </p:selectOneMenu>
                                </div>
                                <div class="col-md-2">
                                    <label class="form-label">Customer</label>
                                    <p:selectOneMenu value="#{voucherManagementMB.selectedCustomerId}"
                                                   styleClass="form-select">
                                        <f:selectItem itemLabel="All Customers" itemValue="#{null}" />
                                        <f:selectItems value="#{voucherManagementMB.customers}"
                                                     var="customer"
                                                     itemLabel="#{customer.firstName} #{customer.lastName}"
                                                     itemValue="#{customer.customerID}" />
                                    </p:selectOneMenu>
                                </div>
                                <div class="col-md-2">
                                    <label class="form-label">Status</label>
                                    <p:selectOneMenu value="#{voucherManagementMB.selectedStatus}"
                                                   styleClass="form-select">
                                        <f:selectItem itemLabel="All Status" itemValue="#{null}" />
                                        <f:selectItem itemLabel="Unused" itemValue="false" />
                                        <f:selectItem itemLabel="Used" itemValue="true" />
                                    </p:selectOneMenu>
                                </div>
                                <div class="col-md-3">
                                    <label class="form-label">&nbsp;</label>
                                    <p:commandButton value="Search"
                                                   icon="fas fa-search"
                                                   action="#{voucherManagementMB.searchVouchers()}"
                                                   styleClass="btn btn-outline-primary w-100" />
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Vouchers DataTable -->
                    <div class="card">
                        <div class="card-body">
                            <p:dataTable value="#{voucherManagementMB.vouchers}"
                                       var="voucher"
                                       paginator="true"
                                       rows="10"
                                       paginatorTemplate="{CurrentPageReport} {FirstPageLink} {PreviousPageLink} {PageLinks} {NextPageLink} {LastPageLink} {RowsPerPageDropdown}"
                                       rowsPerPageTemplate="5,10,15,25"
                                       styleClass="table table-striped"
                                       emptyMessage="No vouchers found">

                                <p:column headerText="Code" sortBy="#{voucher.voucherCode}">
                                    <h:outputText value="#{voucher.voucherCode}" />
                                </p:column>

                                <p:column headerText="Type">
                                    <h:outputText value="#{voucher.offerID != null ? 'Offer' : (voucher.customerID != null ? 'Customer' : 'General')}" />
                                </p:column>

                                <p:column headerText="Customer">
                                    <h:outputText value="#{voucher.customerID != null ? voucher.customerID.firstName : 'N/A'} #{voucher.customerID != null ? voucher.customerID.lastName : ''}" />
                                </p:column>

                                <p:column headerText="Offer" sortBy="#{voucher.offerID.offerName}">
                                    <h:outputText value="#{voucher.offerID != null ? voucher.offerID.offerName : 'N/A'}" />
                                </p:column>

                                <p:column headerText="Discount Value">
                                    <h:outputText value="#{voucher.discountValue}">
                                        <f:convertNumber type="currency" currencySymbol="$" />
                                    </h:outputText>
                                </p:column>

                                <p:column headerText="Expiry Date" sortBy="#{voucher.expiryDate}">
                                    <h:outputText value="#{voucher.expiryDate}">
                                        <f:convertDateTime pattern="dd/MM/yyyy" />
                                    </h:outputText>
                                </p:column>

                                <p:column headerText="Status">
                                    <p:badge value="#{voucher.isUsed ? 'Used' : 'Unused'}"
                                           styleClass="#{voucher.isUsed ? 'bg-danger' : 'bg-success'}" />
                                </p:column>

                                <p:column headerText="Created" sortBy="#{voucher.createdAt}">
                                    <h:outputText value="#{voucher.createdAt}">
                                        <f:convertDateTime pattern="dd/MM/yyyy HH:mm" />
                                    </h:outputText>
                                </p:column>

                                <p:column headerText="Actions" style="width: 150px">
                                    <div class="btn-group" role="group">
                                        <p:commandButton icon="fas fa-edit"
                                                       title="Edit"
                                                       action="#{voucherManagementMB.prepareEdit(voucher)}"
                                                       oncomplete="PF('voucherDialog').show()"
                                                       styleClass="btn btn-sm btn-outline-primary" />

                                        <p:commandButton icon="fas fa-trash"
                                                       title="Delete"
                                                       action="#{voucherManagementMB.deleteVoucher(voucher)}"
                                                       onclick="return confirm('Are you sure you want to delete this voucher?')"
                                                       styleClass="btn btn-sm btn-outline-danger" />
                                    </div>
                                </p:column>
                            </p:dataTable>
                        </div>
                    </div>

                    <!-- Voucher Dialog -->
                    <p:dialog header="#{voucherManagementMB.selectedVoucher.voucherID != null ? 'Edit Voucher' : 'Add New Voucher'}"
                             widgetVar="voucherDialog"
                             modal="true"
                             width="600">

                        <h:panelGrid id="voucherPanel" columns="2" styleClass="ui-grid-responsive" columnClasses="col-4,col-8">
                            <h:outputLabel value="Voucher Code:" />
                            <p:inputText value="#{voucherManagementMB.selectedVoucher.voucherCode}"
                                       required="true"
                                       styleClass="form-control" />

                            <h:outputLabel value="Voucher Type:" />
                            <p:selectOneRadio value="#{voucherManagementMB.voucherType}"
                                            required="true"
                                            styleClass="form-check">
                                <f:selectItem itemLabel="For Customer" itemValue="customer" />
                                <p:ajax event="change" listener="#{voucherManagementMB.onVoucherTypeChange}" update="voucherPanel" />
                            </p:selectOneRadio>

                            <h:outputLabel value="Customer:" rendered="#{voucherManagementMB.voucherType == 'customer'}" />
                            <p:selectOneMenu id="customerSelect" value="#{voucherManagementMB.selectedCustomerId}"
                                           required="#{voucherManagementMB.voucherType == 'customer'}"
                                           rendered="#{voucherManagementMB.voucherType == 'customer'}"
                                           styleClass="form-select">
                                <f:selectItem itemLabel="Select Customer" itemValue="#{null}" />
                                <f:selectItems value="#{voucherManagementMB.customers}"
                                             var="customer"
                                             itemLabel="#{customer.firstName} #{customer.lastName}"
                                             itemValue="#{customer.customerID}" />
                            </p:selectOneMenu>

                            <h:outputLabel value="Offer:" rendered="#{voucherManagementMB.voucherType == 'offer'}" />
                            <p:selectOneMenu id="offerSelect" value="#{voucherManagementMB.selectedOfferId}"
                                           required="#{voucherManagementMB.voucherType == 'offer'}"
                                           rendered="#{voucherManagementMB.voucherType == 'offer'}"
                                           styleClass="form-select">
                                <f:selectItem itemLabel="Select Offer" itemValue="#{null}" />
                                <f:selectItems value="#{voucherManagementMB.eligibleOffers}"
                                             var="offer"
                                             itemLabel="#{offer.offerName}"
                                             itemValue="#{offer.offerID}" />
                                <p:ajax event="change" listener="#{voucherManagementMB.onOfferChange}" update="discountValue,expiryDate" />
                            </p:selectOneMenu>

                            <h:outputLabel value="Discount Value:" />
                            <p:inputNumber id="discountValue" value="#{voucherManagementMB.selectedVoucher.discountValue}"
                                         required="true"
                                         minValue="0"
                                         styleClass="form-control" />

                            <h:outputLabel value="Expiry Date:" />
                            <p:calendar id="expiryDate" value="#{voucherManagementMB.selectedVoucher.expiryDate}"
                                      required="true"
                                      pattern="dd/MM/yyyy"
                                      styleClass="form-control" />

                            <h:outputLabel value="Is Used:" />
                            <p:selectBooleanCheckbox value="#{voucherManagementMB.selectedVoucher.isUsed}" />
                        </h:panelGrid>

                        <f:facet name="footer">
                            <p:commandButton value="Save"
                                           icon="fas fa-save"
                                           action="#{voucherManagementMB.saveVoucher}"
                                           oncomplete="if (!args.validationFailed) PF('voucherDialog').hide()"
                                           styleClass="btn btn-primary me-2" />

                            <p:commandButton value="Cancel"
                                           icon="fas fa-times"
                                           onclick="PF('voucherDialog').hide()"
                                           styleClass="btn btn-secondary" />
                        </f:facet>
                    </p:dialog>
                </h:form>
            </ui:define>
        </ui:composition>
    </h:body>
</html>
