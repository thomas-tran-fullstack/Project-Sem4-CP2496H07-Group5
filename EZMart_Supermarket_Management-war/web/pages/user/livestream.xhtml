<?xml version="1.0" encoding="UTF-8"?>
<ui:composition template="/templates/user/layout.xhtml"
                xmlns="http://www.w3.org/1999/xhtml"
                xmlns:h="jakarta.faces.html"
                xmlns:ui="jakarta.faces.facelets">

    <ui:define name="content">
        <div class="min-h-screen bg-gradient-to-b from-slate-50 to-white dark:from-slate-900 dark:to-slate-800">
            <!-- Header -->
            <div class="sticky top-20 z-40 bg-white/80 dark:bg-slate-900/80 backdrop-blur-md border-b border-slate-200 dark:border-slate-700">
                <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center gap-3">
                            <div class="p-2 bg-red-100 dark:bg-red-900/20 rounded-lg">
                                <span class="material-symbols-outlined text-red-600 dark:text-red-400">live_tv</span>
                            </div>
                            <div>
                                <h1 class="text-2xl font-bold text-slate-900 dark:text-white">Live Now</h1>
                                <p class="text-sm text-slate-600 dark:text-slate-400">Join our live shopping sessions</p>
                            </div>
                        </div>
                        <a href="/EZMart_Supermarket_Management-war/pages/user/livestream-history.xhtml" 
                           class="px-4 py-2 text-sm font-medium text-slate-700 dark:text-slate-200 bg-slate-100 dark:bg-slate-700 rounded-lg hover:bg-slate-200 dark:hover:bg-slate-600 transition-colors flex items-center gap-2">
                            <span class="material-symbols-outlined text-[18px]">history</span>
                            Watch History
                        </a>
                    </div>
                </div>
            </div>

            <!-- Main Content -->
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
                <!-- Filter & Sort -->
                <div class="flex gap-3 mb-6 overflow-x-auto pb-2">
                    <button data-filter="all" class="filter-btn px-4 py-2 text-sm font-medium rounded-full bg-primary text-white transition-all">
                        All Sessions
                    </button>
                    <button data-filter="newest" class="filter-btn px-4 py-2 text-sm font-medium rounded-full bg-white dark:bg-slate-800 text-slate-700 dark:text-slate-200 border border-slate-200 dark:border-slate-700 hover:bg-slate-50 dark:hover:bg-slate-700 transition-colors">
                        Newest
                    </button>
                    <button data-filter="mostviewers" class="filter-btn px-4 py-2 text-sm font-medium rounded-full bg-white dark:bg-slate-800 text-slate-700 dark:text-slate-200 border border-slate-200 dark:border-slate-700 hover:bg-slate-50 dark:hover:bg-slate-700 transition-colors">
                        Most Viewers
                    </button>
                    <button data-filter="trending" class="filter-btn px-4 py-2 text-sm font-medium rounded-full bg-white dark:bg-slate-800 text-slate-700 dark:text-slate-200 border border-slate-200 dark:border-slate-700 hover:bg-slate-50 dark:hover:bg-slate-700 transition-colors">
                        Trending
                    </button>
                </div>

                <!-- Live Sessions Grid -->
                <div id="sessionsList" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4 auto-rows-max">
                    <!-- Sessions will be loaded here -->
                    <div class="col-span-full text-center py-12">
                        <div class="inline-flex items-center gap-2 text-slate-600 dark:text-slate-400">
                            <div class="w-4 h-4 border-2 border-slate-300 border-t-primary rounded-full animate-spin"></div>
                            Loading live sessions...
                        </div>
                    </div>
                </div>

                <!-- Empty State -->
                <div id="emptyState" class="col-span-full text-center py-16" style="display: none;">
                    <div class="inline-flex flex-col items-center gap-4">
                        <div class="w-16 h-16 bg-slate-100 dark:bg-slate-800 rounded-full flex items-center justify-center">
                            <span class="material-symbols-outlined text-3xl text-slate-400">videocam_off</span>
                        </div>
                        <div>
                            <h3 class="text-lg font-semibold text-slate-900 dark:text-white">No sessions live right now</h3>
                            <p class="text-slate-600 dark:text-slate-400 mt-1">Check back soon for our next livestream!</p>
                        </div>
                        <a href="/EZMart_Supermarket_Management-war/pages/user/products.xhtml"
                           class="px-4 py-2 text-sm font-medium text-white bg-primary rounded-lg hover:bg-green-600 transition-colors">
                            Browse Products
                        </a>
                    </div>
                </div>
            </div>
        </div>

        <!-- Watch Modal -->
        <div id="watchModal" style="display: none;" class="fixed inset-0 bg-black/60 z-50 flex items-center justify-center p-4">
            <div class="bg-white dark:bg-slate-900 rounded-xl overflow-hidden max-w-5xl w-full max-h-[90vh] flex flex-col">
                <!-- Modal Header -->
                <div class="flex justify-between items-center p-4 border-b border-slate-200 dark:border-slate-700">
                    <h2 id="modalTitle" class="text-xl font-bold text-slate-900 dark:text-white">Livestream</h2>
                    <button onclick="closeWatchModal()" class="p-1 hover:bg-slate-100 dark:hover:bg-slate-800 rounded-lg transition-colors">
                        <span class="material-symbols-outlined">close</span>
                    </button>
                </div>

                <!-- Modal Content -->
                <div class="flex-1 overflow-y-auto">
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-4 p-6">
                        <!-- Video Player -->
                        <div class="lg:col-span-2">
                            <div id="videoPlayer" class="bg-black rounded-lg aspect-video flex items-center justify-center">
                                <div class="text-center text-white">
                                    <span class="material-symbols-outlined text-[64px] block mb-4">videocam</span>
                                    <p>HLS Stream will play here</p>
                                    <p class="text-sm text-gray-400 mt-2" id="hlsUrl"></p>
                                </div>
                            </div>

                            <!-- Products Section -->
                            <div class="mt-4">
                                <h3 class="text-lg font-semibold text-slate-900 dark:text-white mb-4 flex items-center gap-2">
                                    <span class="material-symbols-outlined">shopping_bag</span>
                                    Featured Products
                                </h3>
                                <div id="modalProducts" class="grid grid-cols-2 gap-3">
                                    <!-- Products loaded here -->
                                </div>
                            </div>
                        </div>

                        <!-- Chat Sidebar -->
                        <div class="flex flex-col h-96">
                            <!-- Chat Header -->
                            <div class="pb-3 border-b border-slate-200 dark:border-slate-700">
                                <h3 class="font-semibold text-slate-900 dark:text-white flex items-center gap-2">
                                    <span class="material-symbols-outlined text-[18px]">chat</span>
                                    Live Chat
                                </h3>
                            </div>

                            <!-- Chat Messages -->
                            <div id="chatMessages" class="flex-1 overflow-y-auto py-3 space-y-2 text-sm">
                                <div class="text-center text-slate-500 py-4">Chat loading...</div>
                            </div>

                            <!-- Chat Input -->
                            <form id="chatForm" class="mt-3 pt-3 border-t border-slate-200 dark:border-slate-700 flex gap-2">
                                <input type="text" id="chatInput" placeholder="Send a message..."
                                       class="flex-1 px-3 py-2 rounded-lg border border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-800 text-slate-900 dark:text-white placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-primary text-sm" />
                                <button type="submit" class="px-3 py-2 bg-primary text-white rounded-lg hover:bg-green-600 transition-colors">
                                    <span class="material-symbols-outlined text-[18px]">send</span>
                                </button>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </ui:define>

    <ui:define name="pageScript">
        <script>
            const API_BASE = '/EZMart_Supermarket_Management-war/resources/api/livestream/customer';
            let currentSessionId = null;
            let currentUserId = 1; // TODO: Get from session
            let ws = null;

            // Load live sessions
            async function loadSessions() {
                try {
                    const response = await fetch(API_BASE + '/live-sessions');
                    const result = await response.json();
                    
                    if (result.success) {
                        const sessions = result.data || [];
                        if (sessions.length === 0) {
                            document.getElementById('sessionsList').innerHTML = '';
                            document.getElementById('emptyState').style.display = 'block';
                        } else {
                            document.getElementById('emptyState').style.display = 'none';
                            displaySessions(sessions);
                        }
                    }
                } catch (error) {
                    console.error('Error loading sessions:', error);
                }
            }

            // Display sessions grid
            function displaySessions(sessions) {
                const html = sessions.map(session => `
                    <div class="group relative overflow-hidden rounded-xl bg-gradient-to-b from-slate-900 to-black cursor-pointer transition-transform duration-300 hover:scale-105"
                         onclick="openWatchModal(${session.sessionId})">
                        <!-- Thumbnail -->
                        <div class="aspect-video bg-slate-800 flex items-center justify-center">
                            ${session.thumbnailUrl ? `
                                <img src="${session.thumbnailUrl}" alt="${session.title}" class="w-full h-full object-cover" />
                            ` : `
                                <div class="text-center">
                                    <span class="material-symbols-outlined text-[64px] text-slate-600">videocam</span>
                                </div>
                            `}
                        </div>

                        <!-- Overlay -->
                        <div class="absolute inset-0 bg-gradient-to-t from-black via-transparent to-transparent opacity-0 group-hover:opacity-100 transition-opacity duration-300 flex items-end p-4">
                            <div class="w-full text-white">
                                <p class="text-sm font-medium mb-2">${session.title}</p>
                                <div class="flex gap-2">
                                    <span class="inline-flex items-center gap-1 text-xs bg-red-600 px-2 py-1 rounded-full font-semibold">
                                        <span class="inline-block w-1.5 h-1.5 bg-current rounded-full animate-pulse"></span>
                                        LIVE
                                    </span>
                                    <span class="inline-flex items-center gap-1 text-xs bg-slate-800 px-2 py-1 rounded-full">
                                        ðŸ‘¥ ${session.currentViewers || 0}
                                    </span>
                                </div>
                            </div>
                        </div>

                        <!-- Live Badge -->
                        <div class="absolute top-3 right-3">
                            <span class="inline-flex items-center gap-1 text-xs font-semibold text-white bg-red-600 px-2 py-1 rounded-full">
                                <span class="inline-block w-1.5 h-1.5 bg-current rounded-full animate-pulse"></span>
                                LIVE
                            </span>
                        </div>

                        <!-- Info -->
                        <div class="absolute bottom-0 left-0 right-0 p-3 bg-gradient-to-t from-black to-transparent text-white">
                            <p class="text-sm font-semibold line-clamp-1">${session.title}</p>
                            <p class="text-xs text-gray-300">by ${session.staffName}</p>
                            <div class="flex gap-2 mt-2 text-xs">
                                <span class="flex items-center gap-1">
                                    <span class="material-symbols-outlined text-[14px]">groups</span>
                                    ${session.currentViewers || 0} watching
                                </span>
                            </div>
                        </div>
                    </div>
                `).join('');

                document.getElementById('sessionsList').innerHTML = html;
            }

            // Open watch modal
            async function openWatchModal(sessionId) {
                currentSessionId = sessionId;

                try {
                    // Load session details
                    const sessionResponse = await fetch(API_BASE + '/sessions/' + sessionId);
                    const sessionResult = await sessionResponse.json();

                    if (!sessionResult.success) {
                        alert('Session not found');
                        return;
                    }

                    const session = sessionResult.data;
                    document.getElementById('modalTitle').textContent = session.title;
                    document.getElementById('hlsUrl').textContent = session.hlsPlaylistURL || 'Streaming...';

                    // Load products
                    const productsResponse = await fetch(API_BASE + '/sessions/' + sessionId + '/products');
                    const productsResult = await productsResponse.json();
                    
                    if (productsResult.success) {
                        const productsHtml = (productsResult.data || []).map(p => `
                            <div class="p-3 bg-slate-50 dark:bg-slate-800 rounded-lg hover:shadow-md transition-shadow">
                                <div class="aspect-square bg-slate-200 dark:bg-slate-700 rounded-lg mb-2 flex items-center justify-center">
                                    ${p.productImage ? `<img src="${p.productImage}" class="w-full h-full object-cover" />` : '<span class="material-symbols-outlined text-slate-400">shopping_bag</span>'}
                                </div>
                                <p class="text-xs font-semibold text-slate-900 dark:text-white line-clamp-2 mb-1">${p.productName}</p>
                                <div class="flex gap-2 text-xs">
                                    ${p.discountPercentage > 0 ? `
                                        <span class="text-slate-600 dark:text-slate-400 line-through">$${parseFloat(p.originalPrice).toFixed(2)}</span>
                                        <span class="font-bold text-primary">$${parseFloat(p.discountedPrice).toFixed(2)}</span>
                                        <span class="text-primary font-bold">-${p.discountPercentage}%</span>
                                    ` : `
                                        <span class="font-bold text-slate-900 dark:text-white">$${parseFloat(p.discountedPrice).toFixed(2)}</span>
                                    `}
                                </div>
                                <button class="w-full mt-2 px-2 py-1 text-xs font-medium text-white bg-primary rounded hover:bg-green-600 transition-colors">
                                    Quick Buy
                                </button>
                            </div>
                        `).join('');
                        document.getElementById('modalProducts').innerHTML = productsHtml;
                    }

                    // Join session
                    const joinResponse = await fetch(API_BASE + '/sessions/' + sessionId + '/join', {
                        method: 'POST'
                    });
                    const joinResult = await joinResponse.json();

                    // Load chat
                    loadChat();

                    // Connect WebSocket
                    connectChat(sessionId);

                    document.getElementById('watchModal').style.display = 'flex';
                } catch (error) {
                    console.error('Error:', error);
                    alert('Error joining session');
                }
            }

            // Close watch modal
            function closeWatchModal() {
                document.getElementById('watchModal').style.display = 'none';
                currentSessionId = null;
                if (ws) ws.close();
            }

            // Load chat messages
            async function loadChat() {
                if (!currentSessionId) return;

                try {
                    const response = await fetch(API_BASE + '/sessions/' + currentSessionId + '/chat');
                    const result = await response.json();

                    if (result.success) {
                        const messagesHtml = (result.data || []).map(msg => `
                            <div class="px-3 py-2 hover:bg-slate-100 dark:hover:bg-slate-800 rounded transition-colors">
                                <p class="text-xs font-semibold text-slate-900 dark:text-white">${msg.username}</p>
                                <p class="text-xs text-slate-600 dark:text-slate-400">${msg.messageText}</p>
                            </div>
                        `).join('');
                        document.getElementById('chatMessages').innerHTML = messagesHtml;
                    }
                } catch (error) {
                    console.error('Error loading chat:', error);
                }
            }

            // Connect WebSocket
            function connectChat(sessionId) {
                try {
                    ws = new WebSocket(WS_BASE + '/' + sessionId + '/' + currentUserId);
                    
                    ws.onmessage = (event) => {
                        const msg = JSON.parse(event.data);
                        if (msg.type === 'message') {
                            addChatMessage(msg.username, msg.message);
                        }
                    };

                    ws.onerror = (error) => {
                        console.error('WebSocket error:', error);
                    };
                } catch (error) {
                    console.error('Error connecting WebSocket:', error);
                }
            }

            // Add message to chat
            function addChatMessage(username, message) {
                const container = document.getElementById('chatMessages');
                const msgDiv = document.createElement('div');
                msgDiv.className = 'px-3 py-2 hover:bg-slate-100 dark:hover:bg-slate-800 rounded transition-colors';
                msgDiv.innerHTML = `
                    <p class="text-xs font-semibold text-slate-900 dark:text-white">${username}</p>
                    <p class="text-xs text-slate-600 dark:text-slate-400">${message}</p>
                `;
                container.appendChild(msgDiv);
                container.scrollTop = container.scrollHeight;
            }

            // Send chat message
            document.getElementById('chatForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                const message = document.getElementById('chatInput').value.trim();
                if (!message || !currentSessionId) return;

                try {
                    const formData = new FormData();
                    formData.append('message', message);

                    const response = await fetch(API_BASE + '/sessions/' + currentSessionId + '/send-message', {
                        method: 'POST',
                        body: formData
                    });

                    if (response.ok) {
                        document.getElementById('chatInput').value = '';
                    }
                } catch (error) {
                    console.error('Error sending message:', error);
                }
            });

            // Filter buttons
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    document.querySelectorAll('.filter-btn').forEach(b => {
                        b.classList.remove('bg-primary', 'text-white');
                        b.classList.add('bg-white', 'dark:bg-slate-800', 'text-slate-700', 'dark:text-slate-200', 'border', 'border-slate-200', 'dark:border-slate-700');
                    });
                    this.classList.remove('bg-white', 'dark:bg-slate-800', 'text-slate-700', 'dark:text-slate-200', 'border', 'border-slate-200', 'dark:border-slate-700');
                    this.classList.add('bg-primary', 'text-white');
                });
            });

            // Load sessions on page load
            loadSessions();
            setInterval(loadSessions, 5000);
        </script>
    </ui:define>
</ui:composition>
