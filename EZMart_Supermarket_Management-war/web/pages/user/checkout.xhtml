<?xml version="1.0" encoding="UTF-8"?>
<ui:composition template="/templates/user/layout.xhtml" xmlns="http://www.w3.org/1999/xhtml"
    xmlns:ui="jakarta.faces.facelets" xmlns:h="jakarta.faces.html" xmlns:f="jakarta.faces.core">
    <ui:define name="content">
        <h:form id="checkoutForm">
            <!-- Thêm phần hiển thị messages ở đầu form để show error/success từ applyVoucher -->
            <h:messages id="globalMessages" showDetail="true" showSummary="false"
                errorClass="text-red-600" infoClass="text-green-600" layout="table" />
            <div class="flex-1 w-full max-w-7xl mx-auto px-4 md:px-10 py-8">
                <!-- Breadcrumbs -->
                <nav class="mb-8 overflow-x-auto">
                    <div class="flex items-center text-sm font-medium whitespace-nowrap">
                        <h:link class="text-gray-500 hover:text-primary transition-colors"
                            outcome="/pages/user/cart.xhtml">Cart</h:link>
                        <span class="mx-3 text-gray-400">/</span>
                        <span class="text-primary font-bold">Checkout</span>
                    </div>
                </nav>

                <div class="grid grid-cols-1 lg:grid-cols-12 gap-8 lg:gap-12">
                    <!-- Left Column: Checkout Form -->
                    <div class="lg:col-span-8 space-y-8">
                        <!-- Page Heading -->
                        <div>
                            <h1
                                class="text-3xl md:text-4xl font-black tracking-tight text-[#111813] dark:text-[#111813] mb-2">
                                Checkout</h1>
                            <p class="text-gray-500 dark:text-gray-400">Complete your order by filling in the details
                                below.</p>
                        </div>

                        <!-- Shipping Information Section -->
                        <section
                            class="bg-white dark:bg-[#1a2e22] rounded-xl border border-gray-100 dark:border-gray-800 p-6 shadow-sm">
                            <div class="mb-6">
                                <h3 class="text-xl font-bold text-[#111813] dark:text-[#111813] mb-1">Contact Details
                                </h3>
                                <p class="text-sm text-gray-500 dark:text-gray-400">We'll use this to update you on your
                                    order.</p>
                            </div>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-5 mb-6">
                                <div class="flex flex-col flex-1">
                                    <h:outputLabel class="text-[#111813] dark:text-gray-200 text-sm font-medium mb-2"
                                        for="firstName">First Name</h:outputLabel>
                                    <h:inputText id="firstName" value="#{checkoutMB.firstName}"
                                        class="form-input w-full rounded-lg border border-[#dce5df] dark:border-[#405646] bg-white dark:bg-[#112116] h-12 px-4 text-base focus:border-primary focus:ring-1 focus:ring-primary placeholder:text-gray-400 dark:placeholder:text-gray-600 transition-colors"
                                        placeholder="e.g. John" required="true" />
                                </div>
                                <div class="flex flex-col flex-1">
                                    <h:outputLabel class="text-[#111813] dark:text-gray-200 text-sm font-medium mb-2"
                                        for="lastName">Last Name</h:outputLabel>
                                    <h:inputText id="lastName" value="#{checkoutMB.lastName}"
                                        class="form-input w-full rounded-lg border border-[#dce5df] dark:border-[#405646] bg-white dark:bg-[#112116] h-12 px-4 text-base focus:border-primary focus:ring-1 focus:ring-primary placeholder:text-gray-400 dark:placeholder:text-gray-600 transition-colors"
                                        placeholder="e.g. Doe" required="true" />
                                </div>
                            </div>
                            <div class="mb-8">
                                <div class="flex flex-col w-full">
                                    <h:outputLabel class="text-[#111813] dark:text-gray-200 text-sm font-medium mb-2"
                                        for="phoneNumber">Phone Number</h:outputLabel>
                                    <div class="relative">
                                        <span
                                            class="absolute left-4 top-1/2 -translate-y-1/2 material-symbols-outlined text-gray-400 text-[20px]">call</span>
                                        <h:inputText id="phoneNumber" value="#{checkoutMB.phoneNumber}"
                                            class="form-input w-full rounded-lg border border-[#dce5df] dark:border-[#405646] bg-white dark:bg-[#112116] h-12 pl-11 pr-4 text-base focus:border-primary focus:ring-1 focus:ring-primary placeholder:text-gray-400 dark:placeholder:text-gray-600 transition-colors"
                                            placeholder="+1 (555) 000-0000" required="true" />
                                    </div>
                                </div>
                            </div>
                            <div class="mb-6">
                                <h3 class="text-xl font-bold text-[#111813] dark:text-[#111813] mb-1">Shipping Address
                                </h3>
                                <p class="text-sm text-gray-500 dark:text-gray-400">Where should we deliver your
                                    groceries?</p>
                            </div>
                            <div class="space-y-5">
                                <!-- Existing Addresses -->
                                <ui:fragment rendered="#{not empty addressCtrl.addresses}">
                                    <h:outputLabel
                                        class="text-[#111813] dark:text-gray-200 text-sm font-medium mb-2 block">Select
                                        Address</h:outputLabel>
                                    <div class="space-y-3 mb-4">
                                        <ui:repeat value="#{addressCtrl.addresses}" var="address" varStatus="status">
                                            <label for="checkoutForm:addressRadio#{status.index}"
                                                class="block border rounded-lg p-4 cursor-pointer #{checkoutMB.selectedAddressID eq address.addressID ? 'border-primary bg-primary/5' : 'border-gray-200 dark:border-gray-700'} hover:border-primary/50">
                                            <h:selectOneRadio id="addressRadio#{status.index}"
                                                    value="#{checkoutMB.selectedAddressID}">
                                                    <f:selectItem itemValue="#{address.addressID}" />
                                                </h:selectOneRadio>
                                                <div>
                                                    <p class="font-medium">
                                                        <ui:fragment rendered="#{not empty address.house}">#{address.house} - </ui:fragment>#{address.street}
                                                    </p>
                                                    <p class="text-sm text-gray-600">
                                                        <ui:fragment rendered="#{not empty address.city}">#{address.city}</ui:fragment>
                                                        <ui:fragment rendered="#{not empty address.region}">, #{address.region}</ui:fragment>
                                                        <ui:fragment rendered="#{not empty address.state}">, #{address.state}</ui:fragment>
                                                        <ui:fragment rendered="#{not empty address.country}">, #{address.country}</ui:fragment>
                                                    </p>
                                                </div>
                                            </label>
                                        </ui:repeat>
                                    </div>
                                    <div class="text-center mb-4">
                                        <h:commandLink action="#{addressCtrl.startAdd()}"
                                            class="text-primary hover:underline">
                                            + Add New Address
                                        </h:commandLink>
                                    </div>
                                </ui:fragment>

                                <!-- New Address Form -->
                                <ui:fragment
                                    rendered="#{empty addressCtrl.addresses or checkoutMB.selectedAddress eq null}">
                                    <div class="flex flex-col w-full">
                                        <h:outputLabel
                                            class="text-[#111813] dark:text-gray-200 text-sm font-medium mb-2"
                                            for="newAddressLine1">Address Line 1</h:outputLabel>
                                        <h:inputText id="newAddressLine1" value="#{checkoutMB.newAddressLine1}"
                                            class="form-input w-full rounded-lg border border-[#dce5df] dark:border-[#405646] bg-white dark:bg-[#112116] h-12 px-4 text-base focus:border-primary focus:ring-1 focus:ring-primary placeholder:text-gray-400 dark:placeholder:text-gray-600 transition-colors"
                                            placeholder="e.g. 123 Green St" required="true" />
                                    </div>
                                    <div class="flex flex-col w-full">
                                        <h:outputLabel
                                            class="text-[#111813] dark:text-gray-200 text-sm font-medium mb-2"
                                            for="newAddressLine2">Address Line 2 (Optional)</h:outputLabel>
                                        <h:inputText id="newAddressLine2" value="#{checkoutMB.newAddressLine2}"
                                            class="form-input w-full rounded-lg border border-[#dce5df] dark:border-[#405646] bg-white dark:bg-[#112116] h-12 px-4 text-base focus:border-primary focus:ring-1 focus:ring-primary placeholder:text-gray-400 dark:placeholder:text-gray-600 transition-colors"
                                            placeholder="e.g. Apt 4B" />
                                    </div>
                                    <div class="grid grid-cols-1 md:grid-cols-3 gap-5">
                                        <div class="flex flex-col w-full">
                                            <h:outputLabel
                                                class="text-[#111813] dark:text-gray-200 text-sm font-medium mb-2"
                                                for="newCity">City</h:outputLabel>
                                            <h:inputText id="newCity" value="#{checkoutMB.newCity}"
                                                class="form-input w-full rounded-lg border border-[#dce5df] dark:border-[#405646] bg-white dark:bg-[#112116] h-12 px-4 text-base focus:border-primary focus:ring-1 focus:ring-primary placeholder:text-gray-400 dark:placeholder:text-gray-600 transition-colors"
                                                placeholder="New York" required="true" />
                                        </div>
                                        <div class="flex flex-col w-full">
                                            <h:outputLabel
                                                class="text-[#111813] dark:text-gray-200 text-sm font-medium mb-2"
                                                for="newState">State / Province</h:outputLabel>
                                            <div class="relative">
                                                <h:selectOneMenu id="newState" value="#{checkoutMB.newState}"
                                                    class="form-select w-full rounded-lg border border-[#dce5df] dark:border-[#405646] bg-white dark:bg-[#112116] h-12 px-4 text-base focus:border-primary focus:ring-1 focus:ring-primary text-[#111813] dark:text-[#111813] transition-colors appearance-none"
                                                    required="true">
                                                    <f:selectItem itemLabel="Select Province/City" itemValue="" />
                                                    <f:selectItem itemLabel="An Giang" itemValue="An Giang" />
                                                    <f:selectItem itemLabel="Bà Rịa - Vũng Tàu" itemValue="Bà Rịa - Vũng Tàu" />
                                                    <f:selectItem itemLabel="Bắc Giang" itemValue="Bắc Giang" />
                                                    <f:selectItem itemLabel="Bắc Kạn" itemValue="Bắc Kạn" />
                                                    <f:selectItem itemLabel="Bạc Liêu" itemValue="Bạc Liêu" />
                                                    <f:selectItem itemLabel="Bắc Ninh" itemValue="Bắc Ninh" />
                                                    <f:selectItem itemLabel="Bến Tre" itemValue="Bến Tre" />
                                                    <f:selectItem itemLabel="Bình Định" itemValue="Bình Định" />
                                                    <f:selectItem itemLabel="Bình Dương" itemValue="Bình Dương" />
                                                    <f:selectItem itemLabel="Bình Phước" itemValue="Bình Phước" />
                                                    <f:selectItem itemLabel="Bình Thuận" itemValue="Bình Thuận" />
                                                    <f:selectItem itemLabel="Cà Mau" itemValue="Cà Mau" />
                                                    <f:selectItem itemLabel="Cao Bằng" itemValue="Cao Bằng" />
                                                    <f:selectItem itemLabel="Đắk Lắk" itemValue="Đắk Lắk" />
                                                    <f:selectItem itemLabel="Đắk Nông" itemValue="Đắk Nông" />
                                                    <f:selectItem itemLabel="Điện Biên" itemValue="Điện Biên" />
                                                    <f:selectItem itemLabel="Đồng Nai" itemValue="Đồng Nai" />
                                                    <f:selectItem itemLabel="Đồng Tháp" itemValue="Đồng Tháp" />
                                                    <f:selectItem itemLabel="Gia Lai" itemValue="Gia Lai" />
                                                    <f:selectItem itemLabel="Hà Giang" itemValue="Hà Giang" />
                                                    <f:selectItem itemLabel="Hà Nam" itemValue="Hà Nam" />
                                                    <f:selectItem itemLabel="Hà Tĩnh" itemValue="Hà Tĩnh" />
                                                    <f:selectItem itemLabel="Hải Dương" itemValue="Hải Dương" />
                                                    <f:selectItem itemLabel="Hậu Giang" itemValue="Hậu Giang" />
                                                    <f:selectItem itemLabel="Hòa Bình" itemValue="Hòa Bình" />
                                                    <f:selectItem itemLabel="Hưng Yên" itemValue="Hưng Yên" />
                                                    <f:selectItem itemLabel="Khánh Hòa" itemValue="Khánh Hòa" />
                                                    <f:selectItem itemLabel="Kiên Giang" itemValue="Kiên Giang" />
                                                    <f:selectItem itemLabel="Kon Tum" itemValue="Kon Tum" />
                                                    <f:selectItem itemLabel="Lai Châu" itemValue="Lai Châu" />
                                                    <f:selectItem itemLabel="Lâm Đồng" itemValue="Lâm Đồng" />
                                                    <f:selectItem itemLabel="Lạng Sơn" itemValue="Lạng Sơn" />
                                                    <f:selectItem itemLabel="Lào Cai" itemValue="Lào Cai" />
                                                    <f:selectItem itemLabel="Long An" itemValue="Long An" />
                                                    <f:selectItem itemLabel="Nam Định" itemValue="Nam Định" />
                                                    <f:selectItem itemLabel="Nghệ An" itemValue="Nghệ An" />
                                                    <f:selectItem itemLabel="Ninh Bình" itemValue="Ninh Bình" />
                                                    <f:selectItem itemLabel="Ninh Thuận" itemValue="Ninh Thuận" />
                                                    <f:selectItem itemLabel="Phú Thọ" itemValue="Phú Thọ" />
                                                    <f:selectItem itemLabel="Quảng Bình" itemValue="Quảng Bình" />
                                                    <f:selectItem itemLabel="Quảng Nam" itemValue="Quảng Nam" />
                                                    <f:selectItem itemLabel="Quảng Ngãi" itemValue="Quảng Ngãi" />
                                                    <f:selectItem itemLabel="Quảng Ninh" itemValue="Quảng Ninh" />
                                                    <f:selectItem itemLabel="Quảng Trị" itemValue="Quảng Trị" />
                                                    <f:selectItem itemLabel="Sóc Trăng" itemValue="Sóc Trăng" />
                                                    <f:selectItem itemLabel="Sơn La" itemValue="Sơn La" />
                                                    <f:selectItem itemLabel="Tây Ninh" itemValue="Tây Ninh" />
                                                    <f:selectItem itemLabel="Thái Bình" itemValue="Thái Bình" />
                                                    <f:selectItem itemLabel="Thái Nguyên" itemValue="Thái Nguyên" />
                                                    <f:selectItem itemLabel="Thanh Hóa" itemValue="Thanh Hóa" />
                                                    <f:selectItem itemLabel="Thừa Thiên Huế" itemValue="Thừa Thiên Huế" />
                                                    <f:selectItem itemLabel="Tiền Giang" itemValue="Tiền Giang" />
                                                    <f:selectItem itemLabel="Trà Vinh" itemValue="Trà Vinh" />
                                                    <f:selectItem itemLabel="Tuyên Quang" itemValue="Tuyên Quang" />
                                                    <f:selectItem itemLabel="Vĩnh Long" itemValue="Vĩnh Long" />
                                                    <f:selectItem itemLabel="Vĩnh Phúc" itemValue="Vĩnh Phúc" />
                                                    <f:selectItem itemLabel="Yên Bái" itemValue="Yên Bái" />
                                                    <f:selectItem itemLabel="Phú Yên" itemValue="Phú Yên" />
                                                    <f:selectItem itemLabel="TP Cần Thơ" itemValue="TP Cần Thơ" />
                                                    <f:selectItem itemLabel="TP Đà Nẵng" itemValue="TP Đà Nẵng" />
                                                    <f:selectItem itemLabel="TP Hải Phòng" itemValue="TP Hải Phòng" />
                                                    <f:selectItem itemLabel="TP Hà Nội" itemValue="TP Hà Nội" />
                                                    <f:selectItem itemLabel="TP Hồ Chí Minh" itemValue="TP Hồ Chí Minh" />
                                                </h:selectOneMenu>
                                                <span
                                                    class="absolute right-4 top-1/2 -translate-y-1/2 material-symbols-outlined pointer-events-none text-gray-500">expand_more</span>
                                            </div>
                                        </div>
                                        <div class="flex flex-col w-full">
                                            <h:outputLabel
                                                class="text-[#111813] dark:text-gray-200 text-sm font-medium mb-2"
                                                for="newZipCode">Zip Code</h:outputLabel>
                                            <h:inputText id="newZipCode" value="#{checkoutMB.newZipCode}"
                                                class="form-input w-full rounded-lg border border-[#dce5df] dark:border-[#405646] bg-white dark:bg-[#112116] h-12 px-4 text-base focus:border-primary focus:ring-1 focus:ring-primary placeholder:text-gray-400 dark:placeholder:text-gray-600 transition-colors"
                                                placeholder="10001" required="true" />
                                        </div>
                                    </div>
                                    <div class="flex items-center gap-3 pt-2">
                                        <h:selectBooleanCheckbox id="saveAddress" value="#{checkoutMB.saveAddress}" />
                                        <h:outputLabel for="saveAddress"
                                            class="text-sm text-[#111813] dark:text-gray-200 cursor-pointer select-none">
                                            Save this address for next time</h:outputLabel>
                                    </div>
                                </ui:fragment>
                            </div>
                        </section>
                        <!-- Delivery Method Section -->
                        <section
                            class="bg-white dark:bg-[#1a2e22] rounded-xl border border-gray-100 dark:border-gray-800 p-6 shadow-sm">
                            <div class="mb-6">
                                <h3 class="text-xl font-bold text-[#111813] dark:text-[#111813] mb-1">Delivery Method
                                </h3>
                                <p class="text-sm text-gray-500 dark:text-gray-400">Select your preferred shipping
                                    option.</p>
                            </div>
                            <div class="flex flex-col w-full">
                                <h:outputLabel
                                    class="text-[#111813] dark:text-gray-200 text-sm font-semibold mb-2 flex items-center gap-2"
                                    for="shippingMethodSelect">
                                    <span
                                        class="material-symbols-outlined text-primary text-[20px]">local_shipping</span>
                                    <!-- Icon truck cho vận chuyển -->
                                    Choose Delivery
                                </h:outputLabel>
                                <div class="relative">
                                    <h:selectOneMenu id="shippingMethodSelect" value="#{checkoutMB.shippingMethod}"
                                        class="form-select w-full rounded-lg border border-[#dce5df] dark:border-[#405646] bg-white dark:bg-[#112116] h-12 px-4 text-base focus:border-primary focus:ring-2 focus:ring-primary/50 text-[#111813] dark:text-[#111813] transition-all hover:border-primary/50 appearance-none">
                                        <f:selectItem
                                            itemLabel="Standard Delivery (Free, 3-5 Business Days - Eco-friendly)"
                                            itemValue="standard" />
                                        <f:selectItem itemLabel="Express Delivery ($15.00, 1-2 Business Days - Fastest)"
                                            itemValue="express" />
                                        <f:ajax event="change" render="@form" />
                                        <!-- Thêm event="change" và render toàn form để cập nhật ngay shipping cost -->
                                    </h:selectOneMenu>

                                    <span
                                        class="absolute right-4 top-1/2 -translate-y-1/2 material-symbols-outlined pointer-events-none text-gray-500">expand_more</span>
                                </div>
                                <p class="text-xs text-gray-500 dark:text-gray-400 mt-2">Your choice affects delivery
                                    time and cost.</p> <!-- Thêm mô tả ngắn -->
                            </div>
                        </section>

                        <!-- Payment Method Selection -->
                        <section
                            class="bg-white dark:bg-[#1a2e22] rounded-xl border border-gray-100 dark:border-gray-800 p-6 shadow-sm">
                            <div class="mb-6">
                                <h3 class="text-xl font-bold text-[#111813] dark:text-[#111813] mb-1">Payment Method
                                </h3>
                                <p class="text-sm text-gray-500 dark:text-gray-400">Choose how you want to pay for your
                                    order.</p>
                            </div>
                            <div class="flex flex-col w-full">
                                <h:outputLabel
                                    class="text-[#111813] dark:text-gray-200 text-sm font-semibold mb-2 flex items-center gap-2"
                                    for="paymentMethodTypeSelect">
                                    <span class="material-symbols-outlined text-primary text-[20px]">payment</span>
                                    Choose Payment
                                </h:outputLabel>
                                <div class="relative">
                                    <h:selectOneMenu id="paymentMethodTypeSelect"
                                        value="#{checkoutMB.paymentMethodType}"
                                        class="form-select w-full rounded-lg border border-[#dce5df] dark:border-[#405646] bg-white dark:bg-[#112116] h-12 px-4 text-base focus:border-primary focus:ring-2 focus:ring-primary/50 text-[#111813] dark:text-[#111813] transition-all hover:border-primary/50 appearance-none">
                                        <f:selectItem itemLabel="Cash on Delivery (Pay when you receive your order)"
                                            itemValue="cod" />
                                        <f:selectItem itemLabel="Online Payment (Bank Transfer/QR Code)"
                                            itemValue="online" />
                                        <f:ajax event="change" render="@form" />
                                    </h:selectOneMenu>
                                    <span
                                        class="absolute right-4 top-1/2 -translate-y-1/2 material-symbols-outlined pointer-events-none text-gray-500">expand_more</span>
                                </div>
                                <p class="text-xs text-gray-500 dark:text-gray-400 mt-2">Choose your preferred payment method.</p>
                            </div>
                        </section>

                    </div>

                    <!-- Right Column: Order Summary (Sticky) -->
                    <div class="lg:col-span-4">
                        <div class="sticky top-24 space-y-6">
                            <div
                                class="bg-white dark:bg-[#1a2e22] rounded-xl border border-gray-100 dark:border-gray-800 p-6 shadow-lg shadow-gray-200/50 dark:shadow-none">
                                <h2 class="text-xl font-bold text-gray-900 dark:text-white mb-4">Order Summary</h2>
                                <!-- Mini Product List -->
                                <div class="space-y-4 mb-6">
                                    <ui:repeat value="#{cartMB.cartItems}" var="item">
                                        <div class="flex gap-3 items-center">
                                            <div
                                                class="h-12 w-12 rounded-lg bg-gray-100 dark:bg-gray-700 overflow-hidden shrink-0">
                                                <ui:param name="checkoutImgPath" value="#{checkoutMB.productImageUrl(item.productID)}" />
                                                <img alt="#{item.productID.productName}"
                                                    class="h-full w-full object-cover"
                                                    src="#{request.contextPath}#{checkoutImgPath}" />
                                            </div>
                                            <div class="flex-1 min-w-0">
                                                <p
                                                    class="text-sm font-semibold text-[#111813] dark:text-[#111813] truncate">
                                                    #{item.productID.productName}</p>
                                                <p class="text-xs text-gray-500 dark:text-gray-400">Qty:
                                                    #{item.quantity}</p>
                                            </div>
                                            <p class="text-sm font-semibold text-[#111813] dark:text-[#111813]">
                                                $#{cartMB.getItemTotal(item)}</p>
                                        </div>
                                    </ui:repeat>
                                </div>
                                <!-- Calculations -->
                                <div id="calculationsSection"
                                    class="border-t border-gray-100 dark:border-gray-800 pt-4 space-y-2">
                                    <div class="flex justify-between text-sm">
                                        <span class="text-gray-600 dark:text-gray-400">Subtotal</span>
                                        <span
                                            class="font-medium text-gray-900 dark:text-white">$#{cartMB.subtotal}</span>
                                    </div>

                                    <div class="flex justify-between text-sm">
                                        <span class="text-gray-600 dark:text-gray-400">Tax</span>
                                        <span
                                            class="font-medium text-gray-900 dark:text-white">$#{checkoutMB.getTaxAmount()}</span>
                                    </div>

                                    <div class="flex justify-between text-sm">
                                        <span class="text-gray-600 dark:text-gray-400">Shipping</span>
                                        <span
                                            class="font-medium text-gray-900 dark:text-white">$#{checkoutMB.getShippingCost()}</span>
                                    </div>

                                    <ui:fragment
                                        rendered="#{checkoutMB.discountAmount != null and checkoutMB.discountAmount > 0}">
                                        <div class="flex justify-between text-sm">
                                            <span class="text-gray-600 dark:text-gray-400">Voucher Discount</span>
                                            <span
                                                class="font-medium text-green-600 dark:text-green-400">-$#{checkoutMB.discountAmount}</span>
                                        </div>
                                    </ui:fragment>

                                </div>
                                <!-- Voucher Input -->
                                <div id="voucherSection"
                                    class="border-t border-gray-100 dark:border-gray-800 pt-4 pb-4">
                                    <div class="flex gap-2">
                                        <h:inputText id="voucherCode" value="#{checkoutMB.voucherCode}"
                                            class="form-input flex-1 rounded-lg border border-[#dce5df] dark:border-[#405646] bg-white dark:bg-[#112116] h-10 px-3 text-sm focus:border-primary focus:ring-1 focus:ring-primary placeholder:text-gray-400 dark:placeholder:text-gray-600 transition-colors"
                                            placeholder="Enter voucher code" />
                                        <h:commandLink action="#{checkoutMB.applyVoucher()}"
                                            class="bg-primary hover:bg-green-600 text-white font-medium px-4 rounded-lg shadow-lg shadow-primary/30 transition-all active:scale-[0.98] text-sm">
                                            <f:ajax execute="voucherCode" render="@form" />
                                            <!-- Thay đổi: render toàn form để cập nhật calculations và total ngay -->
                                            Apply
                                        </h:commandLink>
                                    </div>
                                    <ui:fragment rendered="#{checkoutMB.appliedVoucher != null}">
                                        <div
                                            class="flex items-center justify-between p-2 bg-green-50 dark:bg-green-900/20 border border-green-200 dark:border-green-800 rounded-lg mt-2">
                                            <div class="flex items-center gap-2">
                                                <span
                                                    class="material-symbols-outlined text-green-600 text-sm">check_circle</span>
                                                <span class="text-xs font-medium text-green-800 dark:text-green-200">
                                                    Voucher applied: #{checkoutMB.appliedVoucher.voucherCode}
                                                </span>
                                            </div>
                                            <h:commandLink action="#{checkoutMB.removeVoucher()}" immediate="true"
                                                class="text-red-600 hover:text-red-800 text-xs font-medium">
                                                <f:ajax execute="@this" render="@form" />
                                                <!-- Thay đổi: render toàn form và reset voucherCode -->
                                                Remove
                                            </h:commandLink>
                                        </div>
                                    </ui:fragment>
                                </div>
                                <!-- Total -->
                                <div id="totalSection"
                                    class="border-t border-gray-100 dark:border-gray-800 pt-4 mt-4 mb-6">
                                    <div class="flex justify-between items-center">
                                        <span class="text-base font-bold text-gray-900 dark:text-white">Total</span>
                                        <span
                                            class="text-2xl font-black text-gray-900 dark:text-white">$#{checkoutMB.getFinalTotal()}</span>
                                    </div>
                                </div>
                                <!-- Place Order Button -->
                                <h:commandLink action="#{checkoutMB.placeOrder()}"
                                    class="w-full bg-primary hover:bg-green-600 text-white font-bold text-lg py-3.5 rounded-xl shadow-lg shadow-primary/30 transition-all active:scale-[0.98] flex items-center justify-center gap-2">
                                    <span class="material-symbols-outlined">shopping_cart_checkout</span>
                                    Place Order
                                </h:commandLink>
                                <!-- Trust Badges -->
                                <div class="flex justify-center items-center gap-4 mt-6 text-gray-400">
                                    <div class="flex items-center gap-1 text-xs">
                                        <span class="material-symbols-outlined text-[18px]">verified_user</span>
                                        <span>SSL Secure</span>
                                    </div>
                                    <div class="h-3 w-px bg-gray-300 dark:bg-gray-700"></div>
                                    <div class="flex items-center gap-1 text-xs">
                                        <span class="material-symbols-outlined text-[18px]">shield</span>
                                        <span>Encrypted</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </h:form>
    </ui:define>
</ui:composition>