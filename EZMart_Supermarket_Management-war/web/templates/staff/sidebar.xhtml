<?xml version='1.0' encoding='UTF-8' ?>
<ui:composition xmlns="http://www.w3.org/1999/xhtml" xmlns:h="jakarta.faces.html" xmlns:ui="jakarta.faces.facelets">

    <aside
        class="hidden md:flex flex-col w-64 bg-white dark:bg-[#1a2e22] border-r border-slate-100 dark:border-slate-800 h-full">
        <div class="p-6 flex items-center gap-3">
            <img src="#{request.contextPath}/resources/images/page_logo.png" alt="EZMart Logo" class="h-auto w-full" />
        </div>
        <nav class="flex-1 px-4 space-y-1 overflow-y-auto mt-4" id="sidebarNav">
            <h:link outcome="dashboard"
                styleClass="sidebar-link flex items-center gap-3 px-3 py-2.5 rounded-lg text-slate-700 dark:text-slate-300 hover:bg-slate-100 dark:hover:bg-slate-700 hover:text-slate-900 dark:hover:text-white font-medium transition-all group"
                data-page="dashboard">
                <span class="material-symbols-outlined group-hover:text-primary transition-colors">dashboard</span>
                Dashboard
            </h:link>
            <h:link outcome="/pages/staff/productsmanage"
                styleClass="sidebar-link flex items-center gap-3 px-3 py-2.5 rounded-lg text-slate-600 dark:text-slate-400 hover:bg-slate-50 dark:hover:bg-white/5 hover:text-slate-900 dark:hover:text-white font-medium transition-all group"
                data-page="productsmanage">
                <span class="material-symbols-outlined group-hover:text-primary transition-colors">inventory_2</span>
                Products
            </h:link>
            <h:link outcome="/pages/staff/offersmanage"
                styleClass="sidebar-link flex items-center gap-3 px-3 py-2.5 rounded-lg text-slate-600 dark:text-slate-400 hover:bg-slate-50 dark:hover:bg-white/5 hover:text-slate-900 dark:hover:text-white font-medium transition-all group"
                data-page="offersmanage">
                <span class="material-symbols-outlined group-hover:text-primary transition-colors">local_offer</span>
                Offers
            </h:link>
            <h:link outcome="/pages/staff/ordermanage"
                styleClass="sidebar-link flex items-center gap-3 px-3 py-2.5 rounded-lg text-slate-600 dark:text-slate-400 hover:bg-slate-50 dark:hover:bg-white/5 hover:text-slate-900 dark:hover:text-white font-medium transition-all group"
                data-page="ordermanage">
                <span class="material-symbols-outlined group-hover:text-primary transition-colors">receipt_long</span>
                Orders
            </h:link>
            <h:link outcome="/pages/staff/reviewmanage"
                styleClass="sidebar-link flex items-center gap-3 px-3 py-2.5 rounded-lg text-slate-600 dark:text-slate-400 hover:bg-slate-50 dark:hover:bg-white/5 hover:text-slate-900 dark:hover:text-white font-medium transition-all group"
                data-page="reviewmanage">
                <span class="material-symbols-outlined group-hover:text-primary transition-colors">rate_review</span>
                Reviews
            </h:link>
            <h:link outcome="/pages/staff/feedbackmanagement"
                styleClass="sidebar-link flex items-center gap-3 px-3 py-2.5 rounded-lg text-slate-600 dark:text-slate-400 hover:bg-slate-50 dark:hover:bg-white/5 hover:text-slate-900 dark:hover:text-white font-medium transition-all group"
                data-page="feedbackmanagement">
                <span class="material-symbols-outlined group-hover:text-primary transition-colors">feedback</span>
                Feedback
            </h:link>
            <h:link outcome="staff-chat"
                styleClass="sidebar-link flex items-center gap-3 px-3 py-2.5 rounded-lg text-slate-600 dark:text-slate-400 hover:bg-slate-50 dark:hover:bg-white/5 hover:text-slate-900 dark:hover:text-white font-medium transition-all group relative"
                data-page="staff-chat">
                <span class="material-symbols-outlined group-hover:text-primary transition-colors">chat</span>
                <span>Chat with Customers</span>
                <!-- Unread badge with total unread messages -->
                <h:panelGroup rendered="#{chatController.unreadCount > 0}">
                    <span class="absolute right-2 top-1 inline-flex items-center justify-center h-5 w-5 rounded-full text-xs font-bold text-white bg-red-600">
                        #{chatController.unreadCount > 99 ? '99+' : chatController.unreadCount}
                    </span>
                </h:panelGroup>
            </h:link>
            <div class="pt-4 mt-4 border-t border-slate-100 dark:border-slate-800">
                <p class="px-3 text-xs font-semibold text-slate-400 uppercase tracking-wider mb-2">Account</p>
                <h:link outcome="profile"
                    styleClass="sidebar-link flex items-center gap-3 px-3 py-2.5 rounded-lg text-slate-600 dark:text-slate-400 hover:bg-slate-50 dark:hover:bg-white/5 hover:text-slate-900 dark:hover:text-white font-medium transition-all group"
                    data-page="profile">
                    <span class="material-symbols-outlined group-hover:text-primary transition-colors">person</span>
                    Profile
                </h:link>
            </div>
        </nav>
        <div class="p-4 border-t border-slate-100 dark:border-slate-800">
            <div class="flex items-center gap-3 p-2 rounded-lg bg-slate-50 dark:bg-white/5 cursor-pointer hover:bg-slate-100 dark:hover:bg-white/10 transition-colors"
                onclick="handleUserSectionClick();">
                <div class="h-10 w-10 rounded-full bg-cover bg-center" data-alt="User avatar small"
                    style="background-image: url('#{auth.userProfileImageUrl}');">
                </div>
                <div class="flex-1 min-w-0">
                    <p class="text-sm font-semibold text-slate-900 dark:text-white truncate">
                        #{auth.currentUser != null ? auth.currentUser.username : 'Guest'}</p>
                    <p class="text-xs text-slate-500 dark:text-slate-400 truncate">#{auth.currentUser != null ? auth.currentUser.email : ''}</p>
                </div>
                <h:form>
                    <h:commandLink action="#{auth.logout()}"
                        styleClass="text-slate-400 hover:text-slate-600 dark:hover:text-slate-200 border-none bg-transparent p-0"
                        onclick="event.stopPropagation();">
                        <span class="material-symbols-outlined text-[20px]">logout</span>
                    </h:commandLink>
                </h:form>
            </div>
        </div>
    </aside>

    <script>
        //<![CDATA[
        // Set active sidebar link based on current page
        function setActiveSidebarLink() {
            const currentPath = window.location.pathname;
            const sidebarLinks = document.querySelectorAll('.sidebar-link');
            
            sidebarLinks.forEach(link => {
                const href = link.getAttribute('href');
                if (href && currentPath.includes(href.split('/').pop())) {
                    link.classList.add('active');
                } else {
                    link.classList.remove('active');
                }
            });
        }

        // Run on page load
        document.addEventListener('DOMContentLoaded', setActiveSidebarLink);
        
        function handleUserSectionClick() {
            // Check if user is logged in
            var currentUser = "#{auth.currentUser}";
            var contextPath = "#{request.contextPath}";
            
            if (!currentUser || currentUser === '' || currentUser === 'null') {
                // Not logged in, redirect to login
                window.location.href = contextPath + '/pages/user/login.xhtml';
                return;
            }
            
            // User is logged in, navigate to profile
            window.location.href = contextPath + '/pages/staff/profile.xhtml';
        }
        //]]>
    </script>
</ui:composition>
