<?xml version="1.0" encoding="UTF-8"?>
<ui:composition template="/templates/user/layout.xhtml" xmlns="http://www.w3.org/1999/xhtml"
    xmlns:h="jakarta.faces.html" xmlns:ui="jakarta.faces.facelets" xmlns:f="jakarta.faces.core">
    <ui:define name="content">
        <h:form>
            <div class="flex-1 max-w-[1440px] mx-auto w-full px-4 md:px-8 py-6">
                <!-- Breadcrumbs -->
                <nav aria-label="Breadcrumb" class="flex mb-6">
                    <ol class="inline-flex items-center space-x-1 md:space-x-2">
                        <li class="inline-flex items-center">
                            <a class="inline-flex items-center text-sm font-medium text-slate-500 hover:text-primary dark:text-slate-400"
                                href="#">
                                Home
                            </a>
                        </li>
                        <li>
                            <div class="flex items-center">
                                <span class="material-symbols-outlined text-slate-400 text-sm mx-1">chevron_right</span>
                                <a class="ml-1 text-sm font-medium text-slate-500 hover:text-primary dark:text-slate-400"
                                    href="#">Groceries</a>
                            </div>
                        </li>
                        <li aria-current="page">
                            <div class="flex items-center">
                                <span class="material-symbols-outlined text-slate-400 text-sm mx-1">chevron_right</span>
                                <span class="ml-1 text-sm font-medium text-slate-900 dark:text-white">Fresh
                                    Produce</span>
                            </div>
                        </li>
                    </ol>
                </nav>
                <div class="flex flex-col lg:flex-row gap-8">
                    <!-- Sidebar Filters -->
                    <aside class="w-full lg:w-64 flex-shrink-0 space-y-8 hidden lg:block">
                        <!-- Categories -->
                        <div>
                            <h3 class="font-bold text-slate-900 dark:text-white mb-4">Categories</h3>
                            <h:form>
                                <h:selectManyCheckbox value="#{productMB.selectedCategoryIds}" styleClass="space-y-2"
                                    layout="pageDirection">
                                    <f:selectItems value="#{productMB.categoryItems}" />
                                </h:selectManyCheckbox>
                                <h:commandButton value="Apply Categories" action="#{productMB.applyFilters()}"
                                    styleClass="w-full bg-primary text-white py-2 px-4 rounded-lg hover:bg-green-600 transition-colors mt-3" />
                            </h:form>
                        </div>
                        <!-- Price Range -->
                        <div>
                            <h3 class="font-bold text-slate-900 dark:text-white mb-4">Price Range</h3>
                            <h:form>
                                <div class="flex items-center gap-2 mb-4">
                                    <div class="relative flex-1">
                                        <span
                                            class="absolute inset-y-0 left-0 pl-2 flex items-center text-slate-500 text-xs">$</span>
                                        <h:inputText value="#{productMB.minPrice}"
                                            styleClass="w-full pl-5 pr-2 py-1.5 text-sm bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded focus:ring-1 focus:ring-primary focus:border-primary"
                                            type="number" step="0.01" />
                                    </div>
                                    <span class="text-slate-400">-</span>
                                    <div class="relative flex-1">
                                        <span
                                            class="absolute inset-y-0 left-0 pl-2 flex items-center text-slate-500 text-xs">$</span>
                                        <h:inputText value="#{productMB.maxPrice}"
                                            styleClass="w-full pl-5 pr-2 py-1.5 text-sm bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded focus:ring-1 focus:ring-primary focus:border-primary"
                                            type="number" step="0.01" />
                                    </div>
                                </div>
                                <h:commandButton value="Apply Price Filter" action="#{productMB.applyFilters()}"
                                    styleClass="w-full bg-primary text-white py-2 px-4 rounded-lg hover:bg-green-600 transition-colors" />
                            </h:form>
                        </div>
                        <!-- Brands -->
                        <div>
                            <h3 class="font-bold text-slate-900 dark:text-white mb-4">Brands</h3>
                            <h:form>
                                <h:selectManyCheckbox value="#{productMB.selectedBrandIds}" styleClass="space-y-2"
                                    layout="pageDirection">
                                    <f:selectItems value="#{productMB.brandItems}" />
                                </h:selectManyCheckbox>
                                <h:commandButton value="Apply Brands" action="#{productMB.applyFilters()}"
                                    styleClass="w-full bg-primary text-white py-2 px-4 rounded-lg hover:bg-green-600 transition-colors mt-3" />
                            </h:form>
                        </div>
                    </aside>
                    <!-- Product Grid Area -->
                    <main class="flex-1 min-w-0">
                        <!-- Header & Sort -->
                        <div class="flex flex-col sm:flex-row sm:items-center justify-between gap-4 mb-6">
                            <div>
                                <h1 class="text-3xl font-bold text-slate-900 dark:text-white tracking-tight">All
                                    Products
                                </h1>
                                <p class="text-sm text-slate-500 dark:text-slate-400 mt-1">Showing
                                    #{productMB.paginatedProducts.size()} of #{productMB.totalRecords} products</p>
                            </div>
                            <div class="flex items-center gap-3">
                                <h:outputLabel for="sort" value="Sort by:"
                                    styleClass="text-sm font-medium text-slate-700 dark:text-slate-300 whitespace-nowrap" />
                                <h:selectOneMenu value="#{productMB.selectedSort}"
                                    styleClass="block w-full rounded-lg border-slate-200 bg-white dark:bg-slate-800 dark:border-slate-700 py-2 pl-3 pr-10 text-sm focus:border-primary focus:ring-primary sm:w-44"
                                    id="sort">
                                    <f:selectItems value="#{productMB.sortItems}" />
                                    <f:ajax event="change" execute="@this" render="@form" />
                                </h:selectOneMenu>
                            </div>
                        </div>
                        <!-- Products Grid -->
                        <div id="messagesContainer">
                            <h:messages id="successMessages" globalOnly="false" showDetail="true" showSummary="false"
                                rendered="#{facesContext.maximumSeverity == null or facesContext.maximumSeverity.ordinal le 1}"
                                styleClass="bg-green-100 border border-green-400 text-green-700 px-4 py-3 rounded mb-4" />
                            <h:messages id="errorMessages" globalOnly="false" showDetail="true" showSummary="false"
                                rendered="#{facesContext.maximumSeverity.ordinal ge 2}"
                                styleClass="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded mb-4" />
                        </div>
                        <h:form id="productsForm">
                            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
                                <ui:repeat value="#{productMB.paginatedProducts}" var="product">

                                    <div
                                        class="group bg-surface-light dark:bg-surface-dark rounded-xl border border-slate-200 dark:border-slate-800 p-4 hover:shadow-lg hover:border-primary/30 transition-all duration-300 flex flex-col">

                                        <!-- CLICK ÄI DETAIL -->
                                        <h:link outcome="productdetail">
                                            <f:param name="productId" value="#{product.productID}" />

                                            <div
                                                class="relative aspect-square mb-4 bg-slate-50 dark:bg-slate-800 rounded-lg overflow-hidden">
                                                <ui:param name="productImgPath"
                                                    value="#{productMB.productImageUrl(product)}" />
                                                <img src="#{request.contextPath}#{productImgPath}"
                                                    rendered="#{not empty productImgPath}"
                                                    class="w-full h-full object-cover group-hover:scale-105 transition-transform duration-500"
                                                    alt="#{product.productName}" />
                                                <div class="w-full h-full bg-slate-100 dark:bg-slate-800 flex items-center justify-center text-slate-400"
                                                    rendered="#{empty productImgPath}">
                                                    <span class="material-symbols-outlined text-6xl">image</span>
                                                </div>
                                                
                                                <!-- Wishlist Button - Top Right Corner -->
                                                <h:panelGroup rendered="#{auth.loggedIn}">
                                                    <div class="absolute top-2 right-2 z-10">
                                                        <h:commandButton 
                                                            rendered="#{!wishlistMB.isProductInWishlist(product.productID)}"
                                                            action="#{wishlistMB.addToWishlist(product.productID)}"
                                                            styleClass="w-10 h-10 flex items-center justify-center rounded-full bg-white/90 hover:bg-red-100 text-slate-400 hover:text-red-600 transition-colors shadow-md hover:shadow-lg"
                                                            title="Add to Wishlist"
                                                            value="ðŸ¤"
                                                            style="font-size: 20px; border: none; padding: 0; cursor: pointer; width: 40px; height: 40px; display: flex; align-items: center; justify-content: center;">
                                                            <f:ajax execute="@this" render="@form" immediate="true"/>
                                                        </h:commandButton>
                                                        <h:commandButton 
                                                            rendered="#{wishlistMB.isProductInWishlist(product.productID)}"
                                                            action="#{wishlistMB.removeFromWishlist(product.productID)}"
                                                            styleClass="w-10 h-10 flex items-center justify-center rounded-full bg-red-500 hover:bg-red-600 text-white transition-colors shadow-md hover:shadow-lg"
                                                            title="Remove from Wishlist"
                                                            value="â¤ï¸"
                                                            style="font-size: 20px; border: none; padding: 0; cursor: pointer; width: 40px; height: 40px; display: flex; align-items: center; justify-content: center;">
                                                            <f:ajax execute="@this" render="@form" immediate="true"/>
                                                        </h:commandButton>
                                                    </div>
                                                </h:panelGroup>
                                            </div>

                                            <div class="mb-2">
                                                <h3 class="font-bold text-lg">#{product.productName}</h3>
                                                <p class="text-sm text-slate-500">#{product.categoryID.categoryName}</p>
                                                <p class="text-xs font-medium #{productMB.isOutOfStock(product) ? 'text-red-600' : productMB.isLowStock(product) ? 'text-orange-600' : 'text-green-600'}">
                                                    #{productMB.getStockStatus(product)}
                                                </p>
                                            </div>
                                        </h:link>

                                        <!-- GIÃ + ADD TO CART -->
                                        <div class="flex items-end justify-between mt-auto">

                                            <div>
                                                <div class="flex items-center gap-2">
                                                    <span
                                                        class="block text-xl font-bold #{productMB.hasOffer(product) ? 'text-red-600' : 'text-slate-900 dark:text-white'}">$#{productMB.getDiscountedPrice(product)}</span>
                                                    <span class="text-sm text-slate-400 line-through"
                                                        rendered="#{productMB.hasOffer(product)}">$#{product.unitPrice}</span>
                                                </div>
                                                <span class="text-xs text-slate-400">each</span>
                                                <span class="text-xs text-green-600 font-medium"
                                                    rendered="#{productMB.hasOffer(product)}">#{productMB.getDiscountDisplay(product)}</span>
                                            </div>

                                            <!-- ADD TO CART -->
                                            <div class="flex gap-2">
                                                <h:commandLink action="#{productMB.addProductToCart(product)}"
                                                    styleClass="w-10 h-10 flex items-center justify-center rounded-full #{productMB.isOutOfStock(product) ? 'bg-gray-400 cursor-not-allowed' : 'bg-primary text-white hover:bg-green-600'} transition-colors shadow-sm hover:shadow-md"
                                                    disabled="#{productMB.isOutOfStock(product)}">
                                                    <f:ajax execute="@this" render="@form" />
                                                    <span class="material-symbols-outlined text-[20px]">#{productMB.isOutOfStock(product) ? 'block' : 'add'}</span>
                                                </h:commandLink>
                                            </div>

                                        </div>
                                    </div>

                                </ui:repeat>

                            </div>
                        </h:form>
                        <!-- Pagination -->
                        <div class="mt-12 flex justify-center">
                            <nav aria-label="Pagination" class="flex items-center gap-1">
                                <h:commandLink action="#{productMB.previousPage()}"
                                    styleClass="p-2 rounded-lg hover:bg-slate-100 dark:hover:bg-slate-800 text-slate-500 disabled:opacity-50"
                                    disabled="#{productMB.currentPage == 1}">
                                    <span class="material-symbols-outlined">chevron_left</span>
                                    <f:ajax execute="@this" render="@form" />
                                </h:commandLink>

                                <ui:repeat value="#{productMB.pageNumbers}" var="pageNum">
                                    <h:commandLink action="#{productMB.goToPage(pageNum)}"
                                        styleClass="px-4 py-2 rounded-lg font-medium text-sm #{productMB.currentPage == pageNum ? 'bg-primary text-white' : 'hover:bg-slate-100 dark:hover:bg-slate-800 text-slate-600 dark:text-slate-300'}">
                                        #{pageNum}
                                        <f:ajax execute="@this" render="@form" />
                                    </h:commandLink>
                                </ui:repeat>

                                <h:commandLink action="#{productMB.nextPage()}"
                                    styleClass="p-2 rounded-lg hover:bg-slate-100 dark:hover:bg-slate-800 text-slate-500"
                                    disabled="#{productMB.currentPage == productMB.totalPages}">
                                    <span class="material-symbols-outlined">chevron_right</span>
                                    <f:ajax execute="@this" render="@form" />
                                </h:commandLink>
                            </nav>
                        </div>
                    </main>
                </div>
            </div>
        </h:form>
    </ui:define>
</ui:composition>