<?xml version="1.0" encoding="UTF-8"?>
<ui:composition template="/templates/user/layout.xhtml"
                xmlns="http://www.w3.org/1999/xhtml"
                xmlns:ui="jakarta.faces.facelets"
                xmlns:h="jakarta.faces.html"
                xmlns:f="http://xmlns.jcp.org/jsf/core">
    <ui:define name="content">
        <main class="flex-grow flex items-center justify-center p-4 lg:p-8">
            <div class="w-full max-w-md bg-white dark:bg-[#112116] rounded-2xl shadow-xl overflow-hidden p-8 sm:p-12">
                <!-- Header -->
                <div class="text-center mb-8">
                    <h1 class="text-3xl font-bold tracking-tight text-[#111813] dark:text-white sm:text-4xl mb-2">
                        Verify Email
                    </h1>
                    <p class="text-[#63886f] dark:text-gray-400">
                        We sent a 4-digit verification code to<br/>
                        <strong>#{auth.passwordResetEmail != null ? auth.passwordResetEmail : auth.googleEmail}</strong>
                    </p>
                </div>

                <!-- Error/Success Messages -->
                <h:panelGroup layout="block" styleClass="space-y-2 mb-6">
                    <ui:repeat value="#{facesContext.messageList}" var="msg">
                        <div class="#{msg.severity.ordinal == 2 ? 'bg-red-100 dark:bg-red-900/30 border border-red-300 dark:border-red-700 text-red-800 dark:text-red-200' : 'bg-green-100 dark:bg-green-900/30 border border-green-300 dark:border-green-700 text-green-800 dark:text-green-200'} rounded-lg p-3 flex items-start gap-3">
                            <span class="material-symbols-outlined flex-shrink-0 text-sm">#{msg.severity.ordinal == 2 ? 'error' : 'check_circle'}</span>
                            <span class="text-sm">#{msg.summary}</span>
                        </div>
                    </ui:repeat>
                </h:panelGroup>

                <!-- Form -->
                <h:form id="verifyForm" class="space-y-6">
                    <!-- OTP Input -->
                    <div>
                        <label class="block text-sm font-medium leading-6 text-[#111813] dark:text-gray-200 mb-3">
                            Enter 4-digit Code
                        </label>
                            <div class="flex gap-3 justify-center">
                                <input type="text" inputmode="numeric" maxlength="1" class="otp-digit w-16 h-16 text-center text-3xl font-bold rounded-lg border ring-1 ring-inset ring-[#dce5df]" autocomplete="off" />
                                <input type="text" inputmode="numeric" maxlength="1" class="otp-digit w-16 h-16 text-center text-3xl font-bold rounded-lg border ring-1 ring-inset ring-[#dce5df]" autocomplete="off" />
                                <input type="text" inputmode="numeric" maxlength="1" class="otp-digit w-16 h-16 text-center text-3xl font-bold rounded-lg border ring-1 ring-inset ring-[#dce5df]" autocomplete="off" />
                                <input type="text" inputmode="numeric" maxlength="1" class="otp-digit w-16 h-16 text-center text-3xl font-bold rounded-lg border ring-1 ring-inset ring-[#dce5df]" autocomplete="off" />
                            </div>
                            <h:inputHidden id="otpCombined" value="#{auth.otpInputValue}" />
                            <!-- Also include a plain hidden input with name 'otp' so a standard form submit includes the parameter -->
                            <input type="hidden" id="otpHidden" name="otp" />
                        <p class="text-xs text-[#63886f] dark:text-gray-500 mt-2 text-center">
                            This code will expire in 10 minutes
                        </p>
                    </div>

                    <!-- Verify Button -->
                    <div class="pt-2">
                        <h:commandButton id="verifyBtn" action="#{auth.verifyOtp}"
                                        value="Verify &amp; Continue"
                                        styleClass="flex w-full justify-center rounded-lg bg-primary px-3 py-3.5 text-sm font-bold leading-6 text-white shadow-sm hover:bg-primary-dark focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-primary transition-all active:scale-[0.98]" />
                    </div>

                    <!-- Resend Option -->
                    <div class="text-center text-sm text-[#63886f] dark:text-gray-400">
                        <p>Didn't receive the code?</p>
                        <h:commandLink action="#{auth.resendOtp}" 
                                      styleClass="text-primary hover:text-primary-dark font-semibold transition-colors" 
                                      value="Resend Code" />
                    </div>
                </h:form>

                <!-- Info Box -->
                <div class="mt-8 p-4 bg-blue-50 dark:bg-blue-900/20 border border-blue-200 dark:border-blue-800 rounded-lg">
                    <div class="flex gap-3">
                        <span class="material-symbols-outlined text-blue-600 dark:text-blue-400 flex-shrink-0">info</span>
                        <div class="text-sm text-blue-800 dark:text-blue-300">
                            <p class="font-semibold">Info</p>
                            <p>
                                <h:panelGroup rendered="#{auth.passwordResetEmail != null}">
                                    You're resetting the password for <strong>#{auth.passwordResetEmail}</strong>
                                </h:panelGroup>
                                <h:panelGroup rendered="#{auth.passwordResetEmail == null}">
                                    New to EZMart? We're creating your account with the name <strong>#{auth.googleFullName}</strong>
                                </h:panelGroup>
                            </p>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Include external JS to avoid XHTML/CDATA parsing issues -->
            <h:outputScript library="js" name="verify-otp.js" />
        </main>
    </ui:define>
</ui:composition>
