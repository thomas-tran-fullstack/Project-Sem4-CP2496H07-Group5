# EZMart Livestream - nginx Configuration Template
# Save as: C:\nginx-rtmp\conf\nginx.conf
# Restart nginx after editing: nginx.exe -s reload

worker_processes  1;

# Log error messages
error_log  logs/error.log warn;

events {
    worker_connections  1024;
}

http {
    include       mime.types;
    default_type  application/octet-stream;

    log_format  main  '$remote_addr - $remote_user [$time_local] "$request" '
                      '$status $body_bytes_sent "$http_referer" '
                      '"$http_user_agent" "$http_x_forwarded_for"';

    access_log  logs/access.log  main;

    sendfile        on;
    tcp_nopush      on;
    tcp_nodelay     on;
    keepalive_timeout  65;

    # Gzip compression
    gzip  on;
    gzip_min_length 1024;
    gzip_types text/plain text/css application/json application/javascript;

    # HTTP Server for HLS Files
    server {
        listen       8080;
        server_name  localhost;

        # Serve HLS playlist and video segments
        location /hls {
            types {
                application/vnd.apple.mpegurl m3u8;
                video/mp2t ts;
            }
            
            # Point to HLS directory
            alias C:/hls/;
            
            # Disable caching for live streams
            expires -1;
            add_header Cache-Control "no-cache, no-store, must-revalidate";
            add_header Pragma "no-cache";
            add_header Expires "0";
            
            # CORS headers for cross-origin requests
            add_header Access-Control-Allow-Origin "*";
            add_header Access-Control-Allow-Methods "GET, OPTIONS";
            add_header Access-Control-Allow-Headers "Content-Type";
        }

        # Dashboard / Status (optional)
        location / {
            root   html;
            index  index.html index.htm;
        }

        # Error pages
        error_page   500 502 503 504  /50x.html;
        location = /50x.html {
            root   html;
        }
    }

    # RTMP Configuration
    rtmp {
        server {
            # RTMP Server listening on port 1935
            listen 1935;
            
            # Chunk size (lower = better latency, higher = better bandwidth)
            chunk_size 4096;
            
            # Maximum connections
            max_connections 1000;

            # Live streaming application
            application live {
                # Enable live streaming
                live on;
                
                # Disable recording (set to 'on' to record streams)
                record off;
                
                # (Optional) Record to files:
                # record all;
                # record_path C:/recordings;
                # record_notify on;
                
                # Push/pull for redundancy (optional)
                # push rtmp://backup-server/live;
                
                # Disconnect timeout (ms)
                timeout 10s;
                
                # ===== HLS Conversion using FFmpeg =====
                # When stream is published to rtmp://localhost/live/[name]
                # FFmpeg will encode it to HLS at C:/hls/[name].m3u8
                
                # Basic HLS output (recommended)
                exec ffmpeg -i rtmp://localhost/live/$name \
                    -c:v libx264 \
                    -preset medium \
                    -b:v 2500k \
                    -maxrate 3000k \
                    -bufsize 6000k \
                    -c:a aac \
                    -b:a 128k \
                    -ar 44100 \
                    -f hls \
                    -hls_time 10 \
                    -hls_list_size 3 \
                    -hls_flags delete_segments \
                    -hls_segment_type mpegts \
                    C:/hls/$name.m3u8;

                # Alternative: Lower bitrate for slower networks
                # exec ffmpeg -i rtmp://localhost/live/$name \
                #     -c:v libx264 -preset faster -b:v 1500k \
                #     -c:a aac -b:a 96k \
                #     -f hls -hls_time 10 -hls_list_size 3 -hls_flags delete_segments \
                #     C:/hls/$name.m3u8;

                # Alternative: Higher quality for strong networks
                # exec ffmpeg -i rtmp://localhost/live/$name \
                #     -c:v libx264 -preset slow -b:v 5000k \
                #     -c:a aac -b:a 192k \
                #     -f hls -hls_time 10 -hls_list_size 5 -hls_flags delete_segments \
                #     C:/hls/$name.m3u8;

                # GPU encoding (NVIDIA)
                # exec ffmpeg -i rtmp://localhost/live/$name \
                #     -c:v h264_nvenc -preset medium -rc vbr -b:v 2500k \
                #     -c:a aac -b:a 128k \
                #     -f hls -hls_time 10 -hls_list_size 3 -hls_flags delete_segments \
                #     C:/hls/$name.m3u8;

                # GPU encoding (Intel QSV)
                # exec ffmpeg -hwaccel qsv -i rtmp://localhost/live/$name \
                #     -c:v h264_qsv -preset medium -b:v 2500k \
                #     -c:a aac -b:a 128k \
                #     -f hls -hls_time 10 -hls_list_size 3 -hls_flags delete_segments \
                #     C:/hls/$name.m3u8;
            }
        }
    }
}

# ============================================
# Configuration Explanation:
# ============================================

# RTMP Settings:
# - listen 1935: RTMP server port (OBS streams here)
# - chunk_size: 4KB optimal for low latency
# - live on: Enable live streaming
# - record off: Don't save streams (change to 'on' to save)

# FFmpeg Command:
# - Input: rtmp://localhost/live/$name
#   (receives stream from OBS at this URL)
#
# - Video encoding:
#   -c:v libx264: Use H.264 codec
#   -preset medium: Speed/quality tradeoff
#   -b:v 2500k: Bitrate (2.5 Mbps)
#   -maxrate: Maximum allowed bitrate spike
#   -bufsize: Buffer for rate limiting
#
# - Audio encoding:
#   -c:a aac: Audio codec (AAC)
#   -b:a 128k: Audio bitrate (128 kbps)
#   -ar 44100: Sample rate (44.1 kHz)
#
# - HLS output:
#   -f hls: Format (HLS)
#   -hls_time 10: Segment duration (10 seconds)
#   -hls_list_size 3: Keep 3 segments in playlist
#   -hls_flags delete_segments: Delete old segments
#   Output: C:/hls/$name.m3u8

# ============================================
# Usage:
# ============================================

# 1. Save this file to: C:\nginx-rtmp\conf\nginx.conf
# 2. Create HLS directory: mkdir C:\hls
# 3. Start nginx:
#    cd C:\nginx-rtmp
#    nginx.exe
# 4. In OBS, set:
#    Server: rtmp://localhost:1935/live
#    Stream Key: your_stream_name
# 5. Start streaming
# 6. Verify HLS files: dir C:\hls\
# 7. Test in browser: http://localhost:8080/hls/your_stream_name.m3u8

# ============================================
# Troubleshooting:
# ============================================

# Check if nginx running:
#   tasklist | findstr nginx
#
# Reload config without restart:
#   nginx.exe -s reload
#
# View error log:
#   type logs\error.log
#
# View access log:
#   type logs\access.log
#
# Kill all nginx processes:
#   taskkill /F /IM nginx.exe
#
# Check ports in use:
#   netstat -ano | findstr :1935
#   netstat -ano | findstr :8080

# ============================================
# Performance Tuning:
# ============================================

# For LOW LATENCY (< 5 seconds):
#   -hls_time 2 -hls_list_size 5

# For LOW BANDWIDTH:
#   -b:v 1000k -b:a 64k -preset faster

# For HIGH QUALITY:
#   -b:v 5000k -b:a 192k -preset slow

# For GPU acceleration:
#   Replace -c:v libx264 with h264_nvenc (NVIDIA)
#   or h264_qsv (Intel)

# Check available encoders:
#   ffmpeg -encoders | findstr h264
